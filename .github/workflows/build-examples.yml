name: Build Examples (changed only)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:
    inputs:
      force_all:
        description: "Force build all projects"
        type: boolean
        required: false
        default: false

jobs:
  discover:
    name: Discover changed projects
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          lfs: true

      - name: Compute changed projects matrix
        id: set-matrix
        shell: bash
        env:
          GH_EVENT_NAME: ${{ github.event_name }}
          GH_BASE_REF: ${{ github.base_ref }}
          PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          PUSH_BEFORE_SHA: ${{ github.event.before }}
          GIT_SHA: ${{ github.sha }}
          FORCE_ALL: ${{ inputs.force_all }}
        run: |
          set -euo pipefail

          echo "== Context =========================================="
          echo "Event: ${GH_EVENT_NAME:-}"
          echo "Base ref: ${GH_BASE_REF:-}"
          echo "PR base SHA: ${PR_BASE_SHA:-}"
          echo "PR head SHA: ${PR_HEAD_SHA:-}"
          echo "Push before SHA: ${PUSH_BEFORE_SHA:-}"
          echo "GIT_SHA (current): ${GIT_SHA:-}"
          echo "Repo shallow: $(git rev-parse --is-shallow-repository 2>/dev/null || echo unknown)"
          echo "HEAD: $(git rev-parse --short HEAD 2>/dev/null || echo '?') - $(git show -s --format=%s HEAD 2>/dev/null || echo '?')"

          # List top-level project directories (exclude .git and .github)
          mapfile -t PROJECTS < <(ls -1d */ 2>/dev/null | sed 's:/$::' | grep -vE '^\\.git$|^\\.github$' || true)

          if [ ${#PROJECTS[@]} -eq 0 ]; then
            echo "No project directories found."
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found ${#PROJECTS[@]} project(s): ${PROJECTS[*]}"

          # Optionally force build all projects (workflow_dispatch input)
          force_all_flag="${FORCE_ALL:-false}"
          if [ "$force_all_flag" = "true" ] || [ "$GH_EVENT_NAME" = "push" ]; then
            echo "Force build enabled; selecting all projects."
            selected=("${PROJECTS[@]}")
          else
            # Determine diff file list robustly
            changed_files_tmp="$(mktemp)"
            if [ "$GH_EVENT_NAME" = "pull_request" ]; then
              # Prefer diffing by base SHA from the event payload; this avoids relying on local branch names
              base_sha="${PR_BASE_SHA:-}"
              if [ -n "$base_sha" ] && git cat-file -e "$base_sha^{commit}" 2>/dev/null; then
                git diff --name-only "$base_sha...HEAD" | sed '/^$/d' > "$changed_files_tmp" || true
                echo "Diffing changed files against base SHA $base_sha...HEAD"
              else
                # Fallback: use the base ref name if available; fetch it if missing
                base_ref="${GH_BASE_REF:-}"
                if [ -n "$base_ref" ]; then
                  # Try to ensure the remote-tracking ref exists locally; don't fail the build if fetch fails
                  git fetch --no-tags --prune origin "+refs/heads/$base_ref:refs/remotes/origin/$base_ref" || true
                  if git rev-parse --verify -q "origin/$base_ref" >/dev/null; then
                    git diff --name-only "origin/$base_ref...HEAD" | sed '/^$/d' > "$changed_files_tmp" || true
                    echo "Diffing changed files against origin/$base_ref...HEAD"
                  else
                    # Last resort: diff from the first commit to HEAD
                    first_commit="$(git rev-list --max-parents=0 HEAD | tail -n1)"
                    git diff --name-only "$first_commit" HEAD | sed '/^$/d' > "$changed_files_tmp" || true
                    echo "Base ref '$base_ref' not found; diffing $first_commit..HEAD (fallback)"
                  fi
                else
                  first_commit="$(git rev-list --max-parents=0 HEAD | tail -n1)"
                  git diff --name-only "$first_commit" HEAD | sed '/^$/d' > "$changed_files_tmp" || true
                  echo "No base ref; diffing $first_commit..HEAD (fallback)"
                fi
              fi
            else
              base_sha="${PUSH_BEFORE_SHA:-}"
              head_sha="$GIT_SHA"
              if [ -n "$base_sha" ] && git cat-file -e "$base_sha^{commit}" 2>/dev/null; then
                git diff --name-only "$base_sha" "$head_sha" | sed '/^$/d' > "$changed_files_tmp" || true
                echo "Diffing changed files between $base_sha and $head_sha"
              else
                # Fallbacks: previous commit if available, else initial commit
                if prev="$(git rev-parse HEAD^ 2>/dev/null)"; then
                  git diff --name-only "$prev" "$head_sha" | sed '/^$/d' > "$changed_files_tmp" || true
                  echo "Diffing changed files between $prev and $head_sha (fallback)"
                else
                  first_commit="$(git rev-list --max-parents=0 HEAD | tail -n1)"
                  git diff --name-only "$first_commit" "$head_sha" | sed '/^$/d' > "$changed_files_tmp" || true
                  echo "Diffing changed files between $first_commit and $head_sha (fallback)"
                fi
              fi
            fi

            # Summarize changed files
            changed_count=$(wc -l < "$changed_files_tmp" | tr -d '[:space:]' || echo 0)
            echo "Changed files detected: $changed_count"
            if [ "$changed_count" -gt 0 ]; then
              echo "Changed files (up to first 200):"
              sed -n '1,200p' "$changed_files_tmp" || true
              if [ "$changed_count" -gt 200 ]; then
                echo "(truncated; total $changed_count files)"
              fi
            fi

          # Determine which project directories have changes
          selected=()
            for p in "${PROJECTS[@]}"; do
              if grep -E "^$p/" "$changed_files_tmp" >/dev/null 2>&1; then
                selected+=("$p")
                echo "Project changed: $p"
              fi
            done
          fi
          if [ ${#selected[@]} -eq 0 ]; then
            echo "No project changes detected; nothing to build."
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Selected ${#selected[@]} project(s): ${selected[*]}"

          # Build JSON matrix with dir and java (from .java-version if present)
          items=()
          for dir in "${selected[@]}"; do
            if [ -f "$dir/.java-version" ]; then
              java_ver="$(tr -d '\n' < "$dir/.java-version" | sed 's/[^0-9].*$//')"
            else
              java_ver="25"
            fi
            if [ -z "$java_ver" ]; then java_ver="25"; fi
            items+=("{\"dir\":\"$dir\",\"java\":\"$java_ver\"}")
          done

          json="["$(IFS=,; echo "${items[*]}")"]"
          echo "matrix=$json" | tee -a "$GITHUB_OUTPUT"
          echo "Matrix JSON: $json"

  build:
    name: Build ${{ matrix.dir }} (Java ${{ matrix.java }})
    needs: discover
    if: needs.discover.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Java ${{ matrix.java }} (Gradle cache)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: gradle

      - name: Validate Gradle Wrapper(s)
        uses: gradle/actions/wrapper-validation@v5

      - name: Verify Gradle wrapper
        working-directory: ${{ matrix.dir }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -x ./gradlew ]; then
            ls -l ./gradlew || true
            ls -l gradle/wrapper || true
            if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
              echo "gradle-wrapper.jar is missing. If you use Git LFS, ensure LFS is enabled in checkout (lfs: true)." >&2
              exit 1
            fi
            chmod +x ./gradlew
          else
            echo "No Gradle wrapper script found; skipping verification."
          fi

      - name: Build with Gradle
        working-directory: ${{ matrix.dir }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Gradle build in $(pwd)"
          if [ -x ./gradlew ]; then
            ./gradlew --version
            ./gradlew --no-daemon clean build
          else
            echo "No Gradle wrapper; skipping Gradle build."
          fi

      - name: Setup Java ${{ matrix.java }} (Maven cache)
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}
          cache: maven

      - name: Build with Maven
        working-directory: ${{ matrix.dir }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Maven build in $(pwd)"
          if [ -x ./mvnw ]; then
            ./mvnw -v
            ./mvnw -B -ntp -DskipTests=false clean package
          elif [ -f pom.xml ]; then
            mvn -v
            mvn -B -ntp -DskipTests=false clean package
          else
            echo "No Maven project; skipping Maven build."
          fi

      - name: Verify CLI Template Generation
        shell: bash
        run: |
          set -euo pipefail
          echo "Verifying CLI template generation for ${{ matrix.dir }}"
          ./.github/scripts/verify-templates.sh "${{ matrix.dir }}"

      - name: Upload template artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v6
        with:
          name: template-${{ matrix.dir }}
          path: |
            ${{ matrix.dir }}/
            !${{ matrix.dir }}/build/
            !${{ matrix.dir }}/target/
            !${{ matrix.dir }}/.gradle/
          retention-days: 1

  release:
    name: Publish release
    needs: [discover, build]
    if: >-
      github.event_name == 'push'
      && github.ref == 'refs/heads/main'
      && needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Download all template artifacts
        uses: actions/download-artifact@v7
        with:
          path: staging
          pattern: template-*
          merge-multiple: true

      - name: Package templates
        shell: bash
        run: |
          set -euo pipefail
          echo "Staging contents:"
          ls -la staging/
          cd staging
          zip -r ../templates.zip .
          cd ..
          echo "templates.zip size: $(du -h templates.zip | cut -f1)"
          echo "templates.zip contents (summary):"
          unzip -l templates.zip | tail -5

      - name: Compute version
        id: version
        run: |
          version="$(date -u +%Y.%m).${{ github.run_number }}"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "Release version: $version"

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            templates.zip \
            --title "v${{ steps.version.outputs.version }}" \
            --notes "FluxZero example templates (flux-basic-java, flux-basic-kotlin, gamerental)" \
            --latest

  trigger-cli-build:
    name: Trigger fluxzero-cli build
    needs: [discover, build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.discover.outputs.matrix != '[]'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CLI_BUILD_DISPATCHER_APP_ID }}
          private-key: ${{ secrets.CLI_BUILD_DISPATCHER_PRIVATE_KEY }}
          owner: fluxzero-io
          repositories: fluxzero-cli

      - name: Trigger downstream build
        run: |
          curl -X POST \
            -H "Authorization: token ${{ steps.app-token.outputs.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/fluxzero-io/fluxzero-cli/dispatches \
            -d '{"event_type": "examples-updated", "client_payload": {"sha": "${{ github.sha }}"}}'
